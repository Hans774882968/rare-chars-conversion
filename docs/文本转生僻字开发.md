[TOC]

## `scripts\read_rare_chars.js`开发

`scripts\read_rare_chars.js`用于读取unihan数据库，生成`pinyinDict`字典。

大佬，你是一名专家前端工程师，精通前端工程化。请叫我hans7。我有一个`pinyinDict`字典，它的类型为`Record<string, string[]>`。请帮我写一个函数，遍历每一个数组的每一个字符串s，并执行操作`chineseDict[s] = key`。

LLM给我代码后我才想起来，汉字是有多音字的。最后我修改得到的代码如下：

```js
/**
 * 根据拼音字典反向构建汉字到拼音关键字的映射
 * @param pinyinDict - Record<string, string[]>，如 { "ai": ["爱", "艾", ...] }
 * @returns chineseDict - Record<string, string[]>，如 { "爱": ["ai"], "艾": ["ai"], ... }
 */
export function buildChineseDict(pinyinDict) {
  const chineseDict = {};

  for (const [key, charList] of Object.entries(pinyinDict)) {
    if (!Array.isArray(charList)) continue;

    for (const s of charList) {
      if (!chineseDict[s]) {
        chineseDict[s] = [key];
      } else {
        chineseDict[s].push(key);
      }
    }
  }

  return chineseDict;
}
```

## 界面首次开发

给通义千问的提示词：

大佬，你是一名专家前端工程师，精通前端工程化。请叫我hans7。我希望你帮我开发一个文本转生僻字的小工具，用户输入文本，程序自动将里面的中文文字随机替换为一个相同发音的生僻字，非中文字符不变。我已经有两个字典：

```js
import { chineseDict, pinyinDict } from './lib/pinyinDictCompressedData';

// chineseDict 表示汉字到拼音的映射， pinyinDict 表示拼音到汉字的映射。类型都是 Record<string, string[]>
```

输入框使用shadcn的`Textarea`组件

技术栈：

1. React+Tailwind CSS
2. 组件库为shadcn
3. 图标库使用`react-icons`
4. 使用`sonner`展示提示信息

样式要求：

1. 使用tweakcn的`quantum-rose`主题提供的CSS变量，代码如下：

```css
/* index.css :root, .dark, @theme inline, @layer base */
```

2. 优先使用shadcn的相关组件实现功能，比如Switch、Input、Button等组件

最佳实践：

1. 遵循DRY原则，3次及以上重复出现的代码应抽象为函数、子组件等
2. 不要使用switch语句，用if实现
3. 使用early return、early break、early continue，减少代码嵌套层级

## 首次开发所得界面美化

给我的代码虽然能用，但样式太丑！我想直接用之前项目的代码来改布局，但感觉有点麻烦，还是用提示词来实现了

大佬，请在我给你的代码的基础上修改组件的布局：

1. 输入文本和转换结果各用一个`Card`组件包裹，“输入文本”放左边；“转换结果”放右边
2. 这两个卡片的外面还要额外用一个卡片包裹。最外部的卡片的标题为“文本转生僻字”。所有的卡片标题前面都要有icon
3. “转换为生僻字”按钮放在“输入文本”所在的卡片的下部，“自动转换”按钮相关的代码删掉
4. “复制”按钮和“转换结果”文案放在同一行，靠右对齐

注意移动端适配

技术栈：

1. React+Tailwind CSS
2. 组件库为shadcn
3. 图标库使用`react-icons`
4. 使用`sonner`展示提示信息

---

上面提示词运行效果OK，最后手工修改就完成界面优化了。

## 迟来的技术调研

大佬，你是一名专家前端工程师，精通前端工程化。请叫我hans7。我想实现一个vite+react的纯前端项目，支持显示一段文本中每个中文字符的汉语拼音。请帮我进行技术调研，仔细研究各种获取汉语拼音的方案

大佬，我的vite+react的纯前端项目既需要显示一段文本中每个中文字符的汉语拼音，又需要将文本中的每个中文字符随机替换为一个相同发音的生僻字。请问`pinyin-pro`能胜任吗？如果能胜任，请给出简短的示例代码

大佬，请问unihan数据库有简体中文常用字列表信息吗？如果没有，我应该从哪获取？

调研结果：

1. `pinyin-pro`用于获取拼音，解决多音字问题
2. 我之前的unihan方案用于随机抽取一个相同发音的生僻字
3. https://github.com/DavidSheh/CommonChineseCharacter/blob/master/3500%E5%B8%B8%E7%94%A8%E5%AD%97.txt 获取常用字。`chineseDict`要去掉常用字再抽取

## 重构`convertTextToRareChars`

大佬，如你所见，下面的代码希望实现的功能是：将文本中的每个汉字随机替换为同音生僻字，非中文字符保持不变。现在我希望你帮我改进这个函数：

1. 抽象出一个函数，用来判断一个字符是否为中文字符。如果有相关npm包，优先使用npm包
2. 用`pinyin-pro`获取每个中文字符的拼音，解决现在代码的多音字问题。你需要先像这行代码这样把整个文段扔进去：`pinyin('我very喜欢你', { nonZh: 'consecutive', type: 'all' }); // [{origin: '我', pinyin: 'wǒ'}, {{origin: 'very', pinyin: ''}, ...]`。然后再像现有代码这样逐字符遍历，从`pinyin`函数的返回值中拿到中文字符的正确拼音
3. 我希望你按以下逻辑选取生僻字：记该中文字符为`c`，其拼音为`p`，拼音为`p`的所有中文字符集合为`s1`，`s1`去掉字符`c`的集合为`s11`，`s11`去掉常用字的集合为`s2`。如果`s2`不为空，直接从`s2`中随机选一个字符作为`c`的生僻字。如果`s2`为空但`s11`不为空，尝试从`s11`中随机选一个字符作为`c`的生僻字。如果`s11`为空，则说明该拼音只有一个汉字，不替换`c`。写代码前请帮我检查以上逻辑是否完备
4. 为了实现第3点，我需要在现有的`pinyinDict`基础上新增一个`pinyinDictWithoutCommonlyUsed`，它表示去掉常用字后的`pinyinDict`。请写一个函数帮我实现这个功能。你会用到`commonlyUsedCharSet`变量，它是`Set`实例，存储了3500个常用的中文字符

```js
/**
 * 将文本中的每个汉字随机替换为同音生僻字（若存在）
 * 非中文字符保持不变
 */
export function convertTextToRareChars(
  text,
  chineseDict,
  pinyinDict
) {
  return text
    .split('')
    .map(char => {
      if (!/[\u4e00-\u9fff]/.test(char)) return char;

      // 获取该字的拼音列表（chineseDict[char] 是 string[]）
      const charPinyinList = chineseDict[char];
      if (!charPinyinList || charPinyinList.length === 0) return char;

      // 任选一个拼音（通常只有一个，但多音字可能多个）
      const randomPinyin = charPinyinList[Math.floor(Math.random() * charPinyinList.length)];

      // 获取该拼音对应的所有汉字（含生僻字）
      const candidates = pinyinDict[randomPinyin] || [];
      if (candidates.length === 0) return char;

      // 从候选字中随机选一个（包括原字，也可能选到生僻字）
      return candidates[Math.floor(Math.random() * candidates.length)];
    })
    .join('');
}
```

最佳实践：

1. 遵循DRY原则，3次及以上重复出现的代码应抽象为函数、子组件等
2. 不要使用switch语句，用if实现
3. 使用early return、early break、early continue，减少代码嵌套层级

注：我发现没指定`pinyin`函数的调用方式时，LLM会凭借自己的训练数据无脑调用，于是要对多音字随机选一个拼音，不符合预期。上面“2”的说明有些啰嗦也是没办法。拿到代码后，根据自己项目的上下文改改就能用

## 新增一个下拉框，支持3种模式：仅在生僻字中抽取、在生僻字和常用字中抽取、仅在常用字中抽取

大佬，请添加一个下拉框，选项为：仅在生僻字中抽取、在生僻字和常用字中抽取、仅在常用字中抽取。默认为仅在生僻字中抽取。下拉框使用`shadcn`的`Select`组件。接下来请根据此下拉框的值，修改`convertTextToRareChars`函数。对于每个选项，都要像现有代码这样，考虑好边界情况。你只需要输出需要改动的代码

目前`convertTextToRareChars`函数代码如下：

```js
import isChinese from 'is-chinese';
import { sample } from 'lodash-es';
import { pinyin } from 'pinyin-pro';
import { pinyinDict, pinyinDictWithoutCommonlyUsed } from './pinyinDictCompressedData';

export function convertCharToRareChar(originalChar, pinyin) {
  if (!isChinese(originalChar)) {
    return originalChar;
  }

  if (!pinyin || pinyin === '') {
    return originalChar;
  }

  // s1: 所有同音字
  const s1 = pinyinDict[pinyin] || [];
  // s11: 去掉 originalChar
  const s11 = s1.filter(c => c !== originalChar);

  if (s11.length === 0) {
    return originalChar;
  }

  // s2: s11 中去掉常用字 → 纯生僻字
  const s2 = pinyinDictWithoutCommonlyUsed[pinyin].filter(c => c !== originalChar) || [];

  if (s2.length > 0) {
    return sample(s2);
  }

  return sample(s11);
}

/**
 * 将文本中的每个汉字随机替换为同音生僻字
 * 非中文字符保持不变
 */
export function convertTextToRareChars(
  text
) {
  const pinyinResult = pinyin(text, { nonZh: 'consecutive', type: 'all' });

  return pinyinResult
    .map(({ origin: originalChar, pinyin }) => convertCharToRareChar(originalChar, pinyin))
    .join('');
}
```

LLM反馈：这次LLM生成的代码很烂，还不如自己写！恐怕要开新对话了

## 附录：3500常用字

本来想在此基础上加个查询是不是常用字的功能，想了想没啥用，砍了

## `convertToRareChars.js`单测

改用GLM-4.6，新开对话。

大佬，你是一名专家前端工程师，精通前端工程化。请叫我hans7。我有一个vite+react项目，里面有`src\lib\convertToRareChars.js`文件。其中：

1. `convertTextToRareChars`函数将一个字符串中的每个汉字随机替换为相同发音的生僻字，其他字符保持不变
2. `convertCharToRareChar`将一个汉字随机替换为同音生僻字
3. `getCandidateChars`选择随机抽取的集合。`rare-only`表示仅在生僻字中抽取，`rare-and-common`表示在生僻字和常用字中抽取，`common-only`表示仅在常用字中抽取。如果指定的集合为空，则会自动回退到“在生僻字和常用字中抽取”。如果仍为空，则返回原字符

请帮我写该文件所有函数的测试用例。

技术栈：`vitest`

`src\lib\convertToRareChars.js`完整代码如下：

---

反馈：GLM-4.6生成的代码有一堆莫名其妙的mock。这些mock语法就不对。我只好先让它生成不带mock的测试代码，再自己手动改了。
